App As appinfo:
    BackEnabled: =false
    OnError: =
    OnStart: |+
        =/*Mostrar Spinner Cargando*/
        Set(_VarMostrarCargando,true);
        
        
        /*Colores para la App*/
        Set(_VarColoresApp,
            {
                AzulparaCabeceras: RGBA(4, 31, 65, 1), //041F41
                VerdeParaBotones: RGBA(6, 242, 123, 1), 
                Amarrillo: RGBA(250, 185, 7, 1), 
                Blanco:RGBA(255,255,255,1), 
                AzulFondo:RGBA(0,113, 206,0.7), 
                GrisFondo:RGBA(128, 128, 128, 0.8), 
                BlancoFondo:RGBA(255,255,255,0.5)
                }
            );
        
        /*Pestaña Menu App*/
        Set(_VarMenuSeleccionado,"Noticias");
        
        /* Carga de Perfil por Usuario */
        Set(_Perfil, UsuariosdeOffice365.MyProfileV2());
        Set(_UserFoto, IfError(UsuariosdeOffice365.UserPhotoV2(_Perfil.mail),'no-fotos-1'));
        Set(PermisoUsuario,LookUp(Perfilamiento,Nombre.DisplayName=_Perfil.displayName));
        
        
        /*Modulo de Persona*/
        Set(_VarUsuarioJefe, Upper(Last(Split(First(Split(_Perfil.userPrincipalName,"@")).Value,"|")).Value)) ; //  Upper(Last(Split(First(Split(_Perfil.userPrincipalName;"@")).Value;"|")).Value) || m0a00y0 || c0r076x || L0M02OW
        Set(_VarRolUsuario, LookUp(Lst_Persona,'Correo Electrónico' = _Perfil.mail,Rol));
        //Last(Split(First(Split(_Perfil.userPrincipalName,"@")).Value,"|")).Value)
        //_Perfil.userPrincipalName,"@")
        
        Concurrent(
            ClearCollect(Col_BD_AsignacionEquipos, Filter(Ingresos_Ceses_Personas, Estado = "Activo")),
            ClearCollect(Col_BD_Gerencia, Filter(Lst_Gerencias, Estado = "Activo")),
            ClearCollect(Col_BD_Persona, Filter(Lst_Persona, Estado = "Activo"));
            ClearCollect(Col_BD_Equipos, Filter(DominioEquipoSquad, Estado = "Activo")),
            ClearCollect(Col_MiEquipoWalmart,Filter(Lst_Persona, Jefe_Directo = _VarUsuarioJefe && Estado = "Activo")), //_Perfil.mail "Carlos.Reichmann0@walmart.com"
            ClearCollect(Col_BD_Dominios,Filter(Lst_Dominio, Estado_Lst_Dominio = "Activo")),
            ClearCollect(Col_BD_SubDominios,Filter(Lst_SubDominio, Estado_LstSubDominio = "Activo")),
            ClearCollect(Col_BD_Portafolio,'Dominio - Proyecto/Producto'),
            ClearCollect(Col_BD_Financiamiento,Portafolio),
            ClearCollect(Col_BD_FinanciamientoEquipo,Lst_OrdenesEquipos),
        //    ClearCollect(Col_BD_OA,'Necesidades Walmart Tech'),
            ClearCollect(Col_BD_KPIs,'Outcome - Galería Indice Producto/Métrica'),
            //ClearCollect(Col_BD_DetalleKPIs,OUTCOME),
            ClearCollect(Col_MenuBind,Lst_MenuBind),
            /* PERMISO MODULO EQUIPO VIRTUALES */
            ClearCollect(
                Col_UserPermiso,
                {User:"A0D0GI1"},
                {User:"ASALDES"},
                {User:"D0M0E0D"},
                {User:"Product Owner"},
                {User:"E0R065K"},
                {User:"G0O00SY"},
                {User:"M0G09A7"},
                {User:"M0G09RU"},
                {User:"W0P00K7"},
                {User: Upper("j0m04fx")},
                {User: Upper("f0m00jv")},
                {User: Upper("m0p0k0s")},
                {User: Upper("j0g0dsw")}
            )
            /*===========================================*/ 
        );
        
        
        ClearCollect(Col_DominiosAsignados,LookUp(Perfilamiento,Nombre.DisplayName=_Perfil.displayName,Dominio));  //trae los dominios asignados al usuario
        /*------------------------------------------------------*/
        
        ClearCollect(Col_IDDOminios, Filter(Col_BD_Dominios, Title in Col_DominiosAsignados.Value).IDDominio);
        //ClearCollect(Col_DominiosGestion, Col_BD_Portafolio);
        ClearCollect(Col_DominiosGestion, Filter(Col_BD_Portafolio, IDDominio in Col_IDDOminios.IDDominio));
        
        Clear(Col_IDEquiposAsignados);
        Clear(Col_MiEquiposJefe);
        Clear(Col_DatosparaGrafico);
        
        // Recuperando los ID de los Equipos asignados
        ForAll(Col_MiEquipoWalmart As CME,Collect(Col_IDEquiposAsignados, Filter(Col_BD_AsignacionEquipos, Trim(Usuario) = Trim(CME.Usuario)).IDEquipo));
        //ForAll(Col_MiEquipoWalmart As CME;Collect(Col_DatosparaGrafico; Filter(Col_BD_AsignacionEquipos; Trim(Usuario) = Trim(CME.Usuario))));;
        // Recuperando los equipos asignados en los dominios
        //ForAll(ForAll(Distinct(Col_IDEquiposAsignados;Value); {Result: ThisRecord.Value}) As CIEA;Collect(Col_MiEquiposJefe;Filter(Col_BD_Equipos; IDEquipo= CIEA.Result)));;
        ForAll(ForAll(Distinct(Col_IDEquiposAsignados,IDEquipo), {Result: ThisRecord.Value}) As CIEA,Collect(Col_MiEquiposJefe,Filter(Col_BD_Equipos, IDEquipo = CIEA.Result)));
        ClearCollect(Col_TempMisEquipos,Col_MiEquiposJefe);
        
        Set(_VarCantPersonasaCargo,CountRows(Col_MiEquipoWalmart));
        Set(PermisosPersonas, If(_VarCantPersonasaCargo>0,true,false));
        
        ClearCollect(Col_ValoresCriticidad,
              {ID:1, Value: "Bajo"},
              {ID:2, Value: "Medio"},
              {ID:3, Value: "Alto"}
            );
        
        /* Validar si el usuario es Manager */
        If(
            _VarCantPersonasaCargo >= 1, // VN53SOS -- B0N01DV --_VarUsuarioJefe -- G0T01KR
            Set(_VarEsManager,1),
            Set(_VarEsManager,0)
        );
        
        /* Avisar si tiene alertas el usuario */
        //Set(htmlAlerta; AlertasdesdeBind.Run(_Perfil.mail;_VarEsManager).alertahtml);; //Belen.Neira@walmart.com --livia.ramdey@walmart.com  --  _Perfil.mail --Gonzalo.Toledo@walmart.com
        
        /*Registrar ingreso User*/
        //Patch(Lst_log_usage,Defaults(Lst_log_usage),{Nombre_Usuario:_Perfil.displayName, Usuario:_Perfil.mailNickname,Accion:"Ingreso App"});
        
        /*==================== Menu del usuario ===============================*/
        If(
            !IsBlank(PermisoUsuario),
            Clear(Col_MenudelUsuario);
            ClearCollect(Col_PermisoUsuarioMenu, Split(PermisoUsuario.PermisosMenu,","));
            ForAll(
                Col_PermisoUsuarioMenu As ObtenerMenu,
                Collect(Col_MenudelUsuario, Filter(Col_MenuBind, ID = Value(ObtenerMenu.Value)))
            ),
            Clear(Col_MenudelUsuario);
            ClearCollect(Col_PermisoUsuarioMenu, Split("72,73,76,77,82,86,88,89,90,91,92",",")); // 62,63,64,67,94,72,73,76,77,82,86,88,89,90,91,92,66
            ForAll(
                Col_PermisoUsuarioMenu As ObtenerMenu,
                Collect(Col_MenudelUsuario, Filter(Col_MenuBind, ID = Value(ObtenerMenu.Value)))
            )   
        );
        
        /*==================================================================*/
        
        /*Ocultar Spinner Cargando*/
        Set(_VarMostrarCargando,false);
        
        // Mostrar Comunicado Bind
        //Set(_VarMostrarComunicado,true)
        
        // Recuperando Dominios Asignados
        //ClearCollect(Col_DominiosAsignados; LookUp(Perfilamiento; Nombre.DisplayName = "Carlos Reichmann (Chile)"; Dominio)) // _Perfil.displayName
        //ClearCollect(Col_MiEquiposJefe;Filter(Col_BD_Equipos; ResponsableEquipo = _VarUsuarioJefe));;
        //ForAll(BuscarEquipos;Collect(RelacionEquiposPorUsuario;{Id:ThisRecord.IDBusqueda.Id}))
        
        /*------------------------------------------------------*/
        
    StartScreen: =
    Theme: =PowerAppsTheme

    Host As hostControl.DefaultHostControlVariant:
        OnCancel: =false
        OnEdit: =false
        OnNew: =false
        OnSave: =false
        OnView: =false

